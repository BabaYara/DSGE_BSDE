import Mathlib.Analysis.Calculus.FDeriv
import Mathlib.Analysis.Calculus.ChainRule

-- Chain rule for FrÃ©chet derivatives in Banach spaces.
variable {E F G : Type*} [NormedAddCommGroup E] [NormedSpace â„ E]
  [NormedAddCommGroup F] [NormedSpace â„ F]
  [NormedAddCommGroup G] [NormedSpace â„ G]

theorem chain_rule_composition (Î¦ : E â†’ F) (H : F â†’ G) (X : E)
  (hÎ¦ : DifferentiableAt â„ Î¦ X) (hH : DifferentiableAt â„ H (Î¦ X)) :
  fderiv â„ (H âˆ˜ Î¦) X = (fderiv â„ H (Î¦ X)).comp (fderiv â„ Î¦ X) := by
  exact fderiv.comp X hH hÎ¦
\end{leanproof}

\begin{definition}{Flat derivative (First Variation)}{flat_deriv}
Let $F:\mathcal P_2(S)\to\R$. A \emph{Flat derivative} (first variation) of $F$ at $m$ is a function $\tfrac{\delta F}{\delta m}(m):S\to\R$ such that for every $\nu\in\mathcal P_2(S)$,
\[
\lim_{\epsilon\to 0^+} \frac{F\big((1-\epsilon)m+\epsilon\nu\big)-F(m)}{\epsilon}
= \int_S \frac{\delta F}{\delta m}(m)(\xi)\, (\nu-m)(\diff\xi).
\]
\end{definition}

\begin{lemma}{Chain rule for Flat derivative}{chain_flat}
Let $F(m)=G(\Phi(m))$ with $G:\R\to\R$ differentiable and $\Phi(m)=\int \varphi(\xi)\,m(\diff\xi)$ for integrable $\varphi:S\to\R$. Then
\[
\frac{\delta F}{\delta m}(m)(\xi)=G'(\Phi(m))\,\varphi(\xi).
\]
\end{lemma}

\begin{proof}
Set $m_\epsilon=(1-\epsilon)m+\epsilon\nu$. Then $\Phi(m_\epsilon)=(1-\epsilon)\Phi(m)+\epsilon\Phi(\nu)$. Differentiate $F(m_\epsilon)=G(\Phi(m_\epsilon))$ at $\epsilon=0$ to obtain $G'(\Phi(m))\, (\Phi(\nu)-\Phi(m))=G'(\Phi(m))\int \varphi\, (\nu-m)$, which by \Cref{def:flat_deriv} identifies the first variation as stated.
\end{proof}

\begin{sympycheck}
import sympy as sp
# GÃ¢teaux derivative used in Lemma (Flat chain rule).
G = sp.Function('G')
Phi_m, Phi_nu, eps = sp.symbols('Phi_m Phi_nu eps', real=True)
Phi_m_eps = (1-eps)*Phi_m + eps*Phi_nu
F_m_eps = G(Phi_m_eps)
Gateaux_deriv = sp.diff(F_m_eps, eps).subs(eps, 0)
expected = sp.diff(G(Phi_m), Phi_m) * (Phi_nu - Phi_m)
assert sp.simplify(Gateaux_deriv - expected) == 0
\end{sympycheck}

\begin{tcolorbox}[didacticstyle]
\textbf{Lean sanity (limit cases).} For log utility ($\gamma=1$) or unit EIS ($\psi=1$), the utility-channel risk coefficient vanishes. See Appendix~\ref{app:lean} for Lean4 lemmas \texttt{risk\_coeff\_gamma\_one} and \texttt{risk\_coeff\_psi\_one} confirming these limits.
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{CRITICAL DISTINCTION: Lions vs Flat.}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Lions derivative} $\Dm F(m)(\xi)\in\R^{d_s}$ is a vector field and, for $F=G\circ\Phi$, involves $\nabla\varphi(\xi)$ (\Cref{lem:chain_lions}).
  \item \emph{Flat derivative} $\tfrac{\delta F}{\delta m}(m)(\xi)\in\R$ is scalar and, for $F=G\circ\Phi$, involves $\varphi(\xi)$ (\Cref{lem:chain_flat}).
\end{itemize}
These notions appear in different places in the Master Equation: transport terms use the Lions derivative of $U$, while the direct price externality uses the Flat derivative of the profit functional. Section~\ref{sec:master-equation} should be read with this distinction in mind.\newline
\emph{Editorial note.} This clarifies and corrects an earlier draft in which a chain rule for the Flat derivative was mistakenly identified as the Lions derivative; proofs and applications below (and in Section~\ref{sec:master-equation}) now use the appropriate notions.
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{Application to the price externality (revisited).} Let $\varphi(\xi)=e^{x+\zeta}\kappa^\alpha$ and $G=P$.
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Flat derivative:} by \Cref{lem:chain_flat}, $\tfrac{\delta}{\delta m}\big(P(\Phi(m))\big)(\xi)=P'(Y)\,\varphi(\xi)=P'(Y)\,e^{x+\zeta}\kappa^\alpha$. This scalar derivative feeds the direct price-externality term in \Cref{prop:externality}.
  \item \emph{Lions derivative:} by \Cref{lem:chain_lions}, $\Dm\big(P(\Phi(m))\big)(\xi)=P'(Y)\,\nabla\varphi(\xi)=P'(Y)\,\big(\alpha e^{x+\zeta}\kappa^{\alpha-1},\ e^{x+\zeta}\kappa^\alpha\big)^{\!\top}$, relevant only if $P(\cdot)$ enters transport terms.
\end{itemize}
Multiplying the Flat-derivative expression by the \emph{this-firm} factor $e^{x+z}k^\alpha$ clarifies the marginal-revenue mechanism; in the corrected ME formulation this dependence is handled within the HJB (no separate explicit term).
\end{tcolorbox}

\subsection{Generators, domains, and adjoints}\label{sec:generators}

\begin{definition}{Classical generators and domains}{gens}
For twice continuously differentiable $u$, the one-dimensional second-order generators in the idiosyncratic and aggregate directions act as
\[
\Lz u(z)=\mu_z(z)\,u_z(z)+\tfrac12\,\sigma_z^2\,u_{zz}(z),\qquad
\Lx u(x)=\mu_x(x)\,u_x(x)+\tfrac12\,\sigma_x^2\,u_{xx}(x).
\]
A convenient classical domain is $\mathcal D(\Lz)=C_b^2(\R)$ (or $C_c^2(\R)$ for compact-support arguments); analogously for $\Lx$. Under the local-Lipschitz and linear-growth assumptions on $(\mu,\sigma)$, these generators are closable and generate Feller semigroups on the space of bounded continuous functions.
\end{definition}

\begin{definition}{Adjoints on densities}{adjointraw}
When a density $m(k,z)$ (or $m(x)$) exists, the formal $L^2$-adjoints acting on densities are
\[
\Lzadj m = -\partial_z\big(\mu_z\, m\big) + \tfrac12\, \sigma_z^2\, \partial_{zz} m,\qquad
\Lx^{\!*} m = -\partial_x\big(\mu_x\, m\big) + \tfrac12\, \sigma_x^2\, \partial_{xx} m.
\]
\end{definition}

\begin{lemma}{Adjoint pairing in $z$ and $x$}{adjoint-pairing-zx}
Let $\varphi\in C_c^2(\R)$ and let $m$ be integrable. Then
\[
\int_{\R} (\Lz \varphi)(z)\, m(z)\,\mathrm dz = \int_{\R} \varphi(z)\, (\Lzadj m)(z)\,\mathrm dz,
\qquad
\int_{\R} (\Lx \varphi)(x)\, m(x)\,\mathrm dx = \int_{\R} \varphi(x)\, (\Lx^{\!*} m)(x)\,\mathrm dx.
\]
\end{lemma}

\begin{proof}
Integrate by parts twice, using compact support (or sufficient decay) to kill boundary terms. The drift term yields $\int \mu\,\varphi'\,m = -\int \varphi\,\partial(\mu m)$; the diffusion term yields $\tfrac12\sigma^2\int \varphi'' m = \tfrac12\sigma^2\int \varphi\, m''$.
\end{proof}

\begin{definition}{Transport in $k$ and its adjoint}{transport-k}
Let the transport velocity be $u(k,z,x,m)\equiv i^*(k,z,x,m)-\delta k$. Acting on smooth test functions $\phi=\phi(k)$,
\[
\mathcal T_k\phi \equiv u\,\partial_k\phi,\qquad
\mathcal T_k^{\!*} m \equiv -\partial_k\big(u\,m\big),
\]
so that $\int (\mathcal T_k\phi)\,m = \int \phi\,(\mathcal T_k^{\!*} m)$ whenever boundary fluxes vanish.
\end{definition}

\begin{lemma}{Adjoint pairing in $k$ with reflecting boundary}{adjoint-pairing-k}
If the boundary at $k=0$ is reflecting, the probability flux vanishes: $(u m)|_{k=0}=0$. On any compact truncation $[0,K]$ with conservative outflow at $K$, the adjoint pairing
\[
\int_0^K (u\,\partial_k\phi)\,m\,\mathrm dk = \int_0^K \phi\,\big(-\partial_k(u m)\big)\,\mathrm dk
\]
holds for all $\phi\in C^1([0,K])$.
\end{lemma}

\begin{sympycheck}
import sympy as sp
# Algebraic adjoint identity in 1D: (phi_k)*(a*m) = d_k(phi*a*m) - phi*d_k(a*m)
k = sp.symbols('k', real=True)
phi = sp.Function('phi')(k)
a   = sp.Function('a')(k)
m   = sp.Function('m')(k)
lhs = sp.diff(phi, k) * (a*m)
rhs = sp.diff(phi*(a*m), k) - phi*sp.diff(a*m, k)
assert sp.simplify(lhs - rhs) == 0
\end{sympycheck}

No diffusion in $k$ implies a degenerate (hyperbolic) structure in that dimension; numerical schemes must upwind in $k$ and enforce boundary fluxes consistently.

%========================
% Firm Problem & HJB
%========================
\section{Firm Problem and the Stationary HJB}

Let $V(k,z,x;m)$ denote the value of a firm at $(k,z)$ given aggregate $(x,m)$. The stationary \ac{HJB} is
\begin{equation}
\boxed{\; r(x)\,V
  = \max\_{i\in\R} \Big\{ \pi(k,i,z,x,m) + V\_k\,(i-\delta k) + \Lz V + \Lx V \Big\} \;}
\tag{HJB}\label{eq:HJB}
\end{equation}

\paragraph{Endogenous SDF (drop-in form).}
When the stochastic discount factor is \emph{endogenous}, e.g., from a representative Epstein--Zin (EZ) consumer (\Cref{sec:ez}), the HJB is evaluated under the pricing kernel $M_t$. A convenient implementation keeps physical-measure drifts in $\Lz,\Lx$ and subtracts the risk-price term implied by the market price of risk $\Lambda_t$:
\begin{equation}\label{eq:HJB-EZ}
\boxed{\; r_t\,V
  = \max\_{i\in\R} \Big\{ \pi + V\_k\,(i-\delta k) + \Lz V + \Lx V
      - \underbrace{(\sigma_z V\_z,\, \sigma_x V\_x)\cdot\Lambda_t}\_{\text{pricing-kernel exposure}} \Big\} \;}
\end{equation}
Here $r_t$ and $\Lambda_t$ come from the EZ block. With the EZ aggregator in \Cref{def:ez}, the utility-channel contribution to $\Lambda_t$ equals $(1-\gamma)(1-1/\psi)\,Z_t/V_t$ (\Cref{sdf-ez}); additional consumption-channel terms can be added if $c_t$ has direct Brownian exposure.

The interior first-order condition reads

$$
0=\partial_i\pi+V_k=-(1+h_i(i,k))+V_k
\quad\Longrightarrow\quad
i^*(k,z,x,m)=h_i^{-1}\!\big(V_k-1\big),
$$

with complementarity if $i\ge -\kbar(k)$ is imposed.\footnote{A practical and economically natural choice is to encode a no-scrap constraint $i\ge -\delta k$, which ensures non-negativity of capital along admissible paths.}

\begin{proposition}{Explicit policy under asymmetric quadratic cost}{policy}
For
$h(i,k)=\tfrac{\phi_+}{2}\tfrac{i^2}{k}\,\ind{i\ge 0}
+\tfrac{\phi_-}{2}\tfrac{i^2}{k}\,\ind{i<0}$
with $\phi_->\phi_+$, the optimal policy is

$$
i^*(k,z,x,m)=
\begin{cases}
\dfrac{k}{\phi_+}\,\big(V_k-1\big), & V_k\ge 1,\\[6pt]
\dfrac{k}{\phi_-}\,\big(V_k-1\big), & V_k< 1,
\end{cases}
$$

plus complementarity if a bound $i\ge -\kbar(k)$ applies.
\end{proposition}
\begin{proof}
On each half-line, $h_i(i,k)=\phi_\pm\,i/k$. The FOC $1+h_i(i,k)=V_k$ gives $i=(k/\phi_\pm)(V_k-1)$. Strict convexity in $i$ ensures a unique maximizer; the kink at $i=0$ maps to $V_k=1$. Lower bounds are handled by KKT complementarity.
\end{proof}

% Verification note: Policy FOC formulas are also checked in Appendix E.

\begin{proposition}{Convex Hamiltonian and well-posed policy map}{hamiltonian}
Define the Hamiltonian

$$
\mathcal{H}(k,z,x,m,p)\equiv \max_{i\in\R}\{\pi(k,i,z,x,m)+p\,(i-\delta k)\}.
$$

Then $\mathcal{H}$ is convex in $p=V_k$. The optimizer $i^*(k,z,x,m;p)$ is single-valued, piecewise linear with slope $k/\phi_\pm$, and globally Lipschitz on compact $k$-sets. Hence the feedback map $p\mapsto i^*(\cdot;p)$ is well-posed and stable to perturbations of $p$.
\end{proposition}

\begin{tcolorbox}[didacticstyle]
\sloppy
\begin{tabularx}{\textwidth}{@{}p{0.45\textwidth}X@{}}
\textbf{Intuition} & The firm compares marginal $V_k$ to the frictionless unit price of investment. If $V_k>1$, invest, with slope controlled by $\phi_+$; if $V_k<1$, disinvest, with slope dampened by $\phi_-$ (costlier). The kink at $V_k=1$ generates inaction bands.\\
\textbf{Mathematics} & The Hamiltonian is a convex conjugate of $h$ (after shifting by $p-1$). KKT conditions produce a piecewise-affine policy with a change in slope at $p=1$. Global well-posedness follows from coercivity of $h$ in $i$ and measurability in $k$.
\end{tabularx}
\end{tcolorbox}

% Extra intuition and rigor for HJB/policy mapping
\begin{tcolorbox}[didacticstyle]
\textbf{Economic intuition (expanded).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Investment bands and asymmetry.} The kink at $V_k=1$ creates inaction around the frictionless cutoff; convex asymmetry ($\phi_->\phi_+$) makes disinvestment less responsive than investment. Firms with $V_k$ persistently below one slowly shrink; those above one scale up more elastically.
  \item \emph{Cyclicality.} Through $P(Y)$ and $x$, booms raise $V_k$ via revenues $P(Y)\,q$ and drift terms; more firms cross $V_k>1$ and invest. In downturns, $V_k$ drifts down but disinvestment is muted by higher $\phi_-$. This generates time-variation in the cross-sectional distribution and aggregate $Y$.
  \item \emph{Decomposition.} $V_k$ aggregates (i) private technology and adjustment costs via the Hamiltonian, and (ii) the \emph{general-equilibrium wedge} from inverse-demand slope through $P\big(Y(m,x)\big)$ within the HJB (no separate ME term).
\end{itemize}
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{Mathematical rigor (expanded).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Convexity and envelope.} For fixed $(k,z,x,m)$, $i\mapsto -i-h(i,k)+p\,i$ is strictly concave; the Hamiltonian $\mathcal H(k,\cdot)$ is convex in $p$. By the envelope theorem, $\partial\_p\mathcal H=i^*(p)$ a.e., consistent with Appendix~\ref{app:verification}.
  \item \emph{Well-posed feedback.} Coercivity of $h$ in $i$ and piecewise $C^1$ structure yield a single-valued, globally Lipschitz feedback $p\mapsto i^*(p)$ on compact $k$-sets. KKT handles bounds like $i\ge-\kbar(k)$.
  \item \emph{Boundary conditions.} Reflecting at $k=0$ imposes $i^*(0,\cdot)\ge0$ and zero flux in FP (see \S\ref{eq:FP}); in HJB, subgradient conditions imply $U_k(0,\cdot)\le1$.
\end{itemize}
\end{tcolorbox}

%========================
% FP Equation
%========================
\section{Kolmogorov--Forward (FP) Equation}

Given $x$ and the policy $i^*$, the population law $m_t$ on $(k,z)$ satisfies
\begin{equation}
\partial\_t m = -\frac{\partial}{\partial k}\left((i^\star(k,z,x,m)-\delta k)\, m\right) + \Lzadj m
\tag{FP}\label{eq:FP}
\end{equation}
where $\Lzadj$ is the adjoint of $\Lz$. In stationary equilibrium conditional on $x$: $\partial_t m=0$.

\subsection{Boundary and integrability}
Reflecting at $k=0$ implies zero probability flux through the boundary:
$\big[(i^*-\delta k)m\big]\big|_{k=0}=0$,
and feasibility requires $i^*(0,\cdot)\ge 0$. Integrability of $k^\alpha$ and $1/k$ under $m$ ensures the drift and the dividend terms are finite and the generator/action pairing is well-defined.

\begin{tcolorbox}[mathstyle]
\textbf{Degenerate transport in $k$.} The $k$-direction is purely hyperbolic. Schemes must be \emph{upwind} in $k$ and \emph{conservative} to maintain $\int m=1$. A monotone \ac{FVM} with Godunov fluxes provides stability and positivity. The lack of diffusion in $k$ also means that corners in policy (from irreversibility) do not smooth out via second-order terms; numerical filters should not smear the kink.
\end{tcolorbox}

\begin{tcolorbox}[didacticstyle]
\textbf{Economic intuition (FP, expanded).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Mass flows.} Positive $(i^*-\delta k)$ transports mass toward higher $k$; negative net investment transports it toward $k=0$. The reflecting boundary prevents exit via $k<0$.
  \item \emph{Cross-sectional dynamics.} Asymmetry in $i^*$ induces skewness: expansions push right tails faster than contractions pull left tails, creating persistent heterogeneity in $k$.
  \item \emph{Business-cycle amplification.} When $P(Y)$ is high (tight demand), more mass sees $V_k>1$, raising $Y$ further; the FP captures this propagation via the policy-dependent drift.
\end{itemize}
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{Mathematical rigor (FP, expanded).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Weak formulation.} For test $\varphi\in C^1\_c$, $\frac{\mathrm d}{\mathrm dt}\int \varphi\,m=\int \big[(i^*-\delta k)\,\partial\_k\varphi + \Lz\varphi\big] m$. No-flux at $k=0$ ensures boundary terms vanish.
  \item \emph{Stationarity.} A stationary $m$ solves $\int \big[(i^*-\delta k)\,\partial\_k\varphi + \Lz\varphi\big] m=0$ for all $\varphi$, equivalent to \eqref{eq:FP} in distributional sense.
  \item \emph{Numerics.} Monotone upwinding yields discrete maximum principles and preserves non-negativity/normalization of $m$.
\end{itemize}
\end{tcolorbox}

%========================
% Market Clearing
%========================
\section{Market Clearing and Price Mapping}
Aggregate quantity and price are

$$
Y(m,x)=\int e^{x+z}k^\alpha\,m(\diff k,\diff z),\qquad P=P(Y(m,x)),\quad P'<0.
$$

In the isoelastic case $P(Y)=Y^{-\eta}$ with $\eta>0$,
\begin{equation}\label{eq:isoelastic}
Y\,P'(Y) = -\eta\, P(Y).
\end{equation}
% Verification note: isoelastic identity is checked in Appendix E.

\begin{tcolorbox}[didacticstyle]
\textbf{Economic content.} The aggregation wedge in firm incentives is a simple \emph{marginal-revenue} term: the effect of another unit of firm $k$'s output on the price times firm $k$'s own output. Under isoelastic demand this becomes a proportional tax on revenue with rate $\eta$, varying over the business cycle through $P(Y)$.
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{Mathematical rigor (market mapping).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Monotonicity.} $P'(Y)<0$ yields the Lasry--Lions monotonicity condition for couplings depending on $m$ only through $Y(m,x)$, supporting uniqueness of equilibrium in the mean-field game.
  \item \emph{Comparative statics.} Isoelasticity implies $Y\,P'(Y)=-\eta P(Y)$; hence the marginal-revenue wedge scales linearly with each firm's own output. This homogeneity simplifies existence proofs and discretizations.
  \item \emph{Continuity.} Lipschitz $P$ on compacts and integrability of $k^\alpha$ under $m$ ensure well-defined $Y(m,x)$ and continuous dependence of prices on $m$.
\end{itemize}
\end{tcolorbox}

% %========================
% % Master Equation
% %========================
\section[Master Equation (Stationary, Conditional on x)]{Master Equation (Stationary, Conditional on $x$)}\label{sec:master-equation}
The stationary master equation (ME) characterizes the equilibrium value function $U(k,z,x,m)$ directly. It combines the individual optimization (HJB structure) with the evolution of the population (FP structure), making explicit the feedback from the population onto the individual via the \emph{Lions derivative} $\dmU(\xi;k,z,x,m)$ evaluated at $\xi=(\kappa,\zeta)$. Throughout, we adopt the derivative conventions in \Cref{sec:diff-p2}: population transport uses the \emph{Lions} derivative $\Dm U$; the dependence of profits on $m$ enters implicitly through the HJB terms.

\begin{assumption}{ME regularity and finiteness}{ass:me-regularity}
Working conditional on $x$ (no measure diffusion), assume:
\begin{enumerate}[label=(\alph*),itemsep=0.2em]
  \item $U(\cdot,\cdot,\cdot, m)\in C^{2,1,2}$ in $(k,z,x)$ on compact truncations; reflecting/no-flux holds at $k=0$; $U_k$ is bounded on compacts.
  \item $\Dm U(\cdot; k,z,x,m)$ exists as a vector field on $S$ and is $C^1$ in $\kappa,\zeta$, with a $C^2$ dependence in $\zeta$ so that $\partial_{\zeta\zeta}^2(\Dm U)\!_{\zeta}$ is defined.
  \item $m\in\mathcal P_2(S)$ integrates $k^\alpha$ and $1/k$ where they appear; $i^*(\xi,x,m)$ is measurable in $\xi$ with at most linear growth in $\kappa$.
  \item $P$ is $C^1$ on the relevant range; $Y(m,x)$ is finite; the Flat derivative $\delta_m \pi$ exists as in \Cref{lem:chain_flat}.
\end{enumerate}
These hypotheses ensure all terms in (ME) are well-defined and finite.
\end{assumption}

\subsection{The Master Equation Formulation}\label{sec:me-formulation}

Define the master value $U(k,z,x,m)$ and the Lions derivative $\dmU(\xi;k,z,x,m)\in\R^2$ at $\xi=(\kappa,\zeta)$, with components $\dmU\_\kappa$ and $\dmU\_\zeta$. The drift at $\xi$ is
\[
b(\xi,x,m)=(i^*(\xi,x,m)-\delta\kappa)\,e_k+\mu_z(\zeta)\,e_z,
\]
and diffusion is only in $z$ with variance $\sigma_z^2$. We define the transport operator $\mathcal{T}$ acting on the \emph{Lions} derivative $\dmU$ (as a function of $\xi$):
\[
\mathcal{T}[\dmU](\xi) \equiv (i^*(\xi,x,m)-\delta\kappa)\,\partial\_\kappa\big(\dmU\_\kappa\big)
\; +\; \mu\_z(\zeta)\,\partial\_\zeta\big(\dmU\_\zeta\big)
\; +\; \tfrac12\sigma\_z^2\,\partial^2\_{\zeta\zeta}\big(\dmU\_\zeta\big).
\]
This is the componentwise action of the $(k,z)$ generator on the vector field $\Dm U$; with diffusion only in $z$, the second-order term applies to the $\zeta$-component.

\begin{lemma}{Transport bookkeeping (conditional on $x$)}{transport-bookkeeping}
Under \Cref{ass:me-regularity}, the population-transport term in (ME) equals the average of the generator applied componentwise to $\Dm U$:
\[
\int \mathcal{T}[\Dm U](\xi)\, m(\diff \xi)
= \int \Big[(i^*(\xi,x,m)-\delta\kappa)\,\partial\_{\kappa}(\Dm U)\!\_\kappa
\,+\, \mu\_z(\zeta)\,\partial\_{\zeta}(\Dm U)\!\_\zeta
\,+\, \tfrac12\sigma\_z^2\,\partial^2\_{\zeta\zeta}(\Dm U)\!\_\zeta\Big] \, m(\diff \xi).
\]
\emph{Proof sketch.} Definition-by-components of $\mathcal{T}$ matched to the $(k,z)$ generator; no diffusion in $k$. Reflecting at $k=0$ avoids boundary fluxes.
\end{lemma}

The stationary master equation characterizes the equilibrium $(U,m)$.

\begin{theorem}{Stationary Master Equation (Conditional on $x$)}{ME}
\begin{equation}
\boxed{\begin{aligned}
r(x)\,U(k,z,x,m) &= \underbrace{\max\_{i\in\R}\big\{\pi(k,i,z,x,m) + U_k\,(i-\delta k) + \Lz U + \Lx U\big\}}_{\text{Own-firm HJB terms}} \\
&\quad + \underbrace{\int \mathcal{T}[\dmU](\xi)\, m(\diff \xi)}_{\text{Population transport (uses Lions $\Dm U$, cf. \Cref{sec:diff-p2})}}\,.
\end{aligned}}
\tag{ME}\label{eq:ME}
\end{equation}
Assumptions are given in \Cref{ass:me-regularity}; derivative conventions in \Cref{sec:diff-p2}.
\end{theorem}

\subsection{The Price Externality: Derivation and Simplification}\label{sec:me-externality}

\begin{tcolorbox}[mathstyle]
\textbf{Editorial Correction (Master Equation).} Earlier drafts included an explicit term $\int \delta\_m \pi\,\diff m$ in the Master Equation. This double-counts the measure dependence already present in the HJB via $P\big(Y(m,x)\big)$. The corrected formulation in \Cref{thm:ME} includes only the own-firm HJB terms and the population-transport term; the economic price dependence is implicit in the HJB. This aligns with standard MFG derivations; see \cite{carmona_delarue_2018_mfg,cardaliaguet_delarue_lasry_lions_2019}.
\end{tcolorbox}

\begin{proposition}[Price-externality simplification]\label{prop:externality}
The profit depends on $m$ only through aggregate output $Y(m,x)$. Then
\[
\delta\_m \pi(\xi;\,k,z,x,m)= P'(Y)\,\underbrace{e^{x+z}k^\alpha}\_{\text{This firm's output}}\cdot \underbrace{e^{x+\zeta}\kappa^\alpha}\_{\text{Marginal firm's impact}}.
\]
Consequently,
\[
\int \delta\_m \pi(\xi;\,k,z,x,m)\, m(\diff \xi)
= e^{x+z}k^\alpha\,Y(m,x)\,P'(Y(m,x)).
\]
Under isoelastic demand $P(Y)=Y^{-\eta}$, this becomes $-\eta\,P(Y)\,e^{x+z}k^\alpha$.
\end{proposition}

\begin{lemma}{Zero-externality under flat price}{flat-price-zero}
If $P'(\cdot)\equiv 0$ on the relevant domain, then $\int \delta\_m \pi(\xi;\,k,z,x,m)\, m(\diff \xi)=0$ and the ME reduces to own-firm HJB plus population transport.
\end{lemma}

\begin{proof}
Immediate from \Cref{prop:externality}, since $\delta\_m \pi(\xi;\,\cdot)= e^{x+z}k^\alpha\,P'(Y)\,e^{x+\zeta}\kappa^\alpha$ and $P'\equiv 0$.
\end{proof}

% (proof of \Cref{prop:externality} appears above; omitted duplicate)

\begin{sympycheck}
import sympy as sp
# Verification of the GÃ¢teaux derivative structure via perturbation.
# R(m) = chi_0 * P( <phi, m> ), where chi_0 is this firm's output.
chi_0, Y = sp.symbols('chi_0 Y', positive=True)
P = sp.Function('P')
# Consider a perturbation m_eps = (1-eps)*m + eps*nu.
# Y_eps = <phi, m_eps> = (1-eps)Y + eps*Y_nu.
eps, Y_nu = sp.symbols('eps Y_nu', real=True)
Y_eps = (1-eps)*Y + eps*Y_nu
R_eps = chi_0 * P(Y_eps)
# GÃ¢teaux derivative: d/deps R(m_eps) at eps=0.
Gateaux_deriv = sp.diff(R_eps, eps).subs(eps, 0)
# Expected structure: chi_0 * P'(Y) * (Y_nu - Y).
expected = chi_0 * sp.diff(P(Y), Y) * (Y_nu - Y)
assert sp.simplify(Gateaux_deriv - expected) == 0
\end{sympycheck}

\begin{tcolorbox}[didacticstyle]
\textbf{Common-noise remark.} Because we work conditional on $x$, the measure $m$ does \emph{not} diffuse: the master equation omits second-order measure derivatives. See \Cref{app:common-noise} for a summary of the additional terms that arise when $m$ is driven by common noise (e.g., through $x_t$).
\end{tcolorbox}

\begin{tcolorbox}[didacticstyle]
\textbf{Roles cheat-sheet (ME terms and derivatives).}
\begin{itemize}[leftmargin=1.1em,itemsep=0.25em]
  \item \emph{Own-firm HJB:} classical $(k,z,x)$ derivatives only; no measure derivative.
  \item \emph{Population transport:} \textbf{Lions derivative} $\Dm U$ via $\int \mathcal T[\Dm U]\,\diff m$ \,(\Cref{sec:diff-p2}).
  \item \emph{Price dependence:} captured via $P\big(Y(m,x)\big)$ within the HJB; the Flat derivative $\delta\_m \pi$ is useful for analysis but does not appear as a separate term in the ME.
  \item \emph{Conditional on $x$:} no second-order measure terms (see \Cref{app:common-noise}).
\end{itemize}
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{Mathematical rigor (functional derivative bookkeeping).}
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
  \item \emph{Flat vs. Lions.} If $F(m)=G\!\left(\int \varphi\,\diff m\right)$, then
  $\tfrac{\delta F}{\delta m}(m)(\xi)=G'(\Phi(m))\,\varphi(\xi)$ (scalar first variation),
  while $\Dm F(m)(\xi)=G'(\Phi(m))\,\nabla\varphi(\xi)$ (vector Lions derivative), cf. \Cref{lem:chain\_flat,lem:chain\_lions}.
  \item \emph{ME structure.} The stationary ME collects: own-firm HJB (which already includes the dependence on $m$ through $P(Y)$) and population transport via the \emph{Lions} derivative $\Dm U$ (see \Cref{app:master-derivation}). Conditioning on $x$ removes second-order terms in the measure.
  \item \emph{Equivalence.} Under monotonicity and regularity (Lasry--Lions), the stationary HJB--FP fixed point and the ME solution coincide; see Appendix references.
\end{itemize}
\end{tcolorbox}

\subsection{Equivalence and Uniqueness}

\begin{theorem}{Equivalence (Sketch)}{equivalence}
Under \Cref{ass:primitives,ass:regularity} and standard monotonicity/regularity hypotheses (Lasry--Lions), stationary solutions $(V,m)$ of the coupled \ac{HJB}--\ac{FP} system (\Cref{eq:HJB}, \Cref{eq:FP}) coincide with stationary solutions $U$ of the Master Equation (\Cref{thm:ME}) such that $U(\cdot, m) = V(\cdot; m)$, conditional on $x$.
\end{theorem}

\begin{tcolorbox}[literaturestyle]
\textbf{Equivalence and uniqueness.} The Lasry--Lions monotonicity condition (here satisfied by the strictly decreasing inverse demand $P'(Y)<0$) ensures uniqueness of the mean-field equilibrium. This guarantees the identification between the HJB--FP solution and the ME solution. See Lasry \& Lions (2007) for the PDE case and Cardaliaguet--Delarue--Lasry--Lions (2019) for the general theory of master equations and the convergence of finite-$N$ games.
\end{tcolorbox}

% Schematic: ME term composition
\begin{figure}[ht]
\centering
\begin{tikzpicture}[
  node distance=18mm,
  box/.style={rectangle, draw=darkgreen, rounded corners, thick, inner sep=6pt, align=center}
]
\node[box] (hjb) {Own-firm HJB\\$\max\_i\{\cdots\}$};
\node[box, right=of hjb] (pop) {Population transport\\via $\mathcal{T}[\Dm U]$};
\node[box, below=of hjb] (me) {ME residual};
\draw[->, thick] (hjb) -- (me);
\draw[->, thick] (pop) -- (me);
\node[anchor=north] at ($(hjb.south)!0.5!(pop.south)$) {\small conditioned on $x$ (no measure diffusion)};
\end{tikzpicture}
\caption{Schematic composition of the stationary master equation: own-firm HJB contributions (including price dependence on $m$) and population transport via the Lions derivative.}
\end{figure}

\begin{tcolorbox}[didacticstyle]
\textbf{Recap â€” Master Equation.}
\begin{itemize}[leftmargin=1.15em,itemsep=0.2em]
  \item ME residual combines HJB at $(k,z,x)$ and transport over $m$.
  \item Conditioning on $x$ removes second-order terms in the measure.
  \item Under monotonicity, ME and HJB--FP fixed point are equivalent.
\end{itemize}
\end{tcolorbox}

%========================
% Boundary & Regularity
%========================
\section{Boundary and Regularity Conditions}

\paragraph{Boundary at $k=0$.} Reflecting: the probability flux vanishes and feasible controls satisfy $i^*\ge 0$ at the boundary. A sufficient condition enforcing no instantaneous arbitrage is $U_k(0,\cdot)\le 1$ (marginal value of installed capital no higher than the unit purchase price).

\paragraph{Growth.} From the coercivity of $h$ in $i$ and the linear drift in $k$, one obtains $U(k,z,x,m)=O(k)$ as $k\to\infty$. This ensures finiteness of the HJB Hamiltonian and stabilizes numerical approximations.

\paragraph{Integrability.} Admissible distributions $m$ integrate $k^\alpha$ and $1/k$ where these appear (e.g., $\E_m[k^\alpha]$ in $Y$ and $i^2/k$ in adjustment costs). In practice one imposes a numerically compact domain in $k$ with conservative outflow at the upper boundary.

\begin{tcolorbox}[didacticstyle]
\textbf{Economic translation.} Reflecting $k=0$ prevents negative capital; growth bounds rule out explosive investment; integrability ensures dividends and costs are well-defined across firms. These are the minimal conditions that keep the economics clean and the PDEs well-posed.
\end{tcolorbox}

%========================
% Computation
%========================
\section{Computation: Two KS-Free Routes}

\subsection{Route A: \ac{HJB}--\ac{FP} Fixed Point}\label{sec:routeA}

\paragraph{Algorithm (stationary, conditional on $x$).}
\begin{enumerate}[leftmargin=1.5em,label=\textbf{A.\arabic*}]
\item \textbf{Outer loop over $x$.} Either fix $x$ on a grid of business-cycle states or integrate final objects against the invariant law of $x$ (solved from $\Lx^\ast$).
\item \textbf{Initialize $m^{(0)}$.} Choose a feasible stationary guess (e.g., log-normal in $k$ with support bounded away from $0$ and invariant $z$-marginal).
\item \textbf{HJB step.} Given $m^{(n)}$, compute $Y^{(n)}$ and $P(Y^{(n)})$. Solve \Cref{eq:HJB} for $V^{(n)}$ using \ac{SL} or policy iteration. Recover $i^{*,(n)}$ from \Cref{prop:policy}.
\item \textbf{FP step.} Given $i^{*,(n)}$, solve stationary \Cref{eq:FP} for $m^{(n+1)}$ using a conservative \ac{FVM} with upwind flux in $k$ and standard diffusion stencil in $z$.
\item \textbf{Update.} Set $m^{(n+1)}\leftarrow (1-\theta)m^{(n)}+\theta\,\widehat m^{(n+1)}$ with damping $\theta\in(0,1]$. Iterate until residuals (below) fall below tolerance.
\end{enumerate}

\paragraph{Discretization details.}
\begin{itemize}[leftmargin=1.25em]
\item \emph{Grid in $k$.} Log grid $k_j=k_{\min}\exp(j\Delta)$ improves resolution near $0$. Reflecting boundary at $k_{\min}$ enforces $i^*\!\ge 0$.
\item \emph{Upwinding.} Flux $F_{j+1/2}=\max\{u_{j+1/2},0\}m_j+\min\{u_{j+1/2},0\}m_{j+1}$ with velocity $u=i^*-\delta k$.
\item \emph{Diffusion in $z$.} Centered second differences with Neumann/absorbing at truncation $\pm z_{\max}$.
\item \emph{HJB solver.} Policy iteration: guess $i$, solve linear system for $V$; update $i$ by \Cref{prop:policy}; repeat. Alternatively, \ac{SL} schemes avoid CFL limits.
\end{itemize}

\paragraph{Diagnostics.} In practice, $\log$-residuals drop nearly linearly until policy stabilizes; distributional stability is checked by mass-conservation and small Wasserstein drift between iterations.

\subsection{Route B: Direct Master-PDE Collocation}\label{sec:routeB}

\subsubsection*{Representation of functions of measures}
We parameterize the master value $U_\omega$ and its Lions derivative $\dmU_\psi$ using a permutation-invariant DeepSets architecture \cite{zaheer2017deepsets} suitable for empirical measures $m=\tfrac1N\sum_{n=1}^N\delta_{\xi^n}$.

\begin{definition}{DeepSets Architecture}{deepsets}
A function $F:\mathcal{P}(S)\to\R$ is approximated by
\[
F(m) \approx F_{\theta,\phi}(m) = \rho_\theta\!\left( \frac{1}{N}\sum_{n=1}^N \Phi_\phi(\xi^n) \right),
\]
where $\Phi_\phi:S\to\R^d$ is the feature encoder (shared across atoms), the summation is the symmetric pooling operator, and $\rho_\theta: \R^d\to\R$ is the readout network.
\end{definition}

We use a shared embedding $\Phi_\phi(m)=\tfrac{1}{N}\sum_n \Phi_\phi(\xi^n)$ and define
\[
U_\omega(k,z,x,m) \approx \rho^U_{\theta_U}\big(k,z,x,\Phi_\phi(m)\big),\qquad
\dmU_\psi(\xi; k,z,x,m) \approx \rho^{\Dm U}_{\theta_{DU}}\big(\xi,k,z,x,\Phi_\phi(m)\big).
\]

\begin{tcolorbox}[didacticstyle]
\textbf{Why DeepSets?} $U$ and $\Dm U$ depend on the \emph{distribution} $m$, not firm identities. DeepSets enforces permutation invariance by construction via pooling and serves as a universal approximator for continuous set functions \cite{zaheer2017deepsets}.
\end{tcolorbox}

\paragraph{Algorithm (Direct ME Collocation).}
\begin{enumerate}[leftmargin=1.5em,label=\textbf{B.\arabic*}]
\item Initialize parameters $\omega,\psi$.
\item Sample collocation tuples $(k_i,z_i,x_i; m_i)$ with empirical $m_i$.
\item Compute residuals $\widehat{\mathcal{R}}_{\mathrm{ME}}(\omega,\psi)$ as in \Cref{app:loss}.
\item Minimize $\mathcal{L}=\E[\widehat{\mathcal{R}}_{\mathrm{ME}}^2]+\lambda_{\mathrm{KKT}}\mathcal{P}_{\mathrm{KKT}}+\lambda_{\mathrm{bdry}}\mathcal{P}_{\mathrm{bdry}}+\lambda_{\mathrm{anchor}}\mathcal{P}_{\mathrm{anchor}}$ via SGD.
\item Validate against Route-A residuals.
\end{enumerate}

\begin{tcolorbox}[mathstyle]
\textbf{Computational Insight: Scalability.} Route B avoids an outer HJB--FP fixed point and directly minimizes the ME residual. The DeepSets embedding keeps the dependence on $m$ tractable as the number of atoms $N$ grows, mitigating the combinatorial explosion from permutations.
\end{tcolorbox}

\begin{tcolorbox}[mathstyle]
\textbf{On identifiability.} Because $\dmU$ appears only through $\partial_\kappa\dmU, \partial_\zeta\dmU, \partial_{\\zeta\\zeta}^2\dmU$, adding constants leaves the ME invariant. An anchoring penalty $\mathcal{P}_{\mathrm{anchor}}=\big(\int \dmU\,\diff m\big)^2$ fixes the gauge.
\end{tcolorbox}

%========================
% % Verification & Diagnostics
% %========================
\section{Verification and Diagnostics}\label{sec:verification}

\paragraph{Residual norms.}
For collocation tuples $(k,z,x,m)$:
\begin{align*}
\mathcal{R}_{\mathrm{HJB}} &\equiv r(x)\, V - \max_{i}\{\pi + V_k\,(i-\delta k) + \Lz V + \Lx V\},\\
\mathcal{R}_{\mathrm{FP}}  &\equiv -\partial_k\big[(i^*-\delta k),m\big] + \Lzadj m,\\
\mathcal{R}_{\mathrm{ME}}  &\equiv r(x)\,U - \Big(\max_{i}\{\pi + U_k\,(i-\delta k) + \Lz U + \Lx U\}
  + \int\cdots\dxi
  \Big).
\end{align*}
  Typical norms: $L^2$ over collocation points or weighted Sobolev norms. KKT and boundary penalties are added for feasibility; in Route A, measure $\mathrm{W}_2$ drifts between iterations provide a sharp distributional diagnostic.

\paragraph{Stopping rules.}
Stop when $\|\mathcal{R}_{\mathrm{ME}}\|<\varepsilon_{\mathrm{ME}}$, $\|\mathcal{R}_{\mathrm{HJB}}\|<\varepsilon_{\mathrm{HJB}}$, $\|\mathcal{R}_{\mathrm{FP}}\|<\varepsilon_{\mathrm{FP}}$, and policy/distribution drifts fall below thresholds, e.g., $\sup|i^{*,(n+1)}-i^{*,(n)}|<10^{-5}$ and $\mathrm{W}_2(m^{(n+1)},m^{(n)})<10^{-4}$.

\begin{table}[ht]
\centering
\small
\begin{tabular}{@{}lccc@{}}
\toprule
Residual & Tight & Medium & Coarse \\
\midrule
$\varepsilon_{\mathrm{ME}}$ & $10^{-5}$ & $10^{-4}$ & $10^{-3}$ \\
$\varepsilon_{\mathrm{HJB}}$ & $10^{-7}$ & $10^{-6}$ & $10^{-5}$ \\
$\varepsilon_{\mathrm{FP}}$  & $10^{-7}$ & $10^{-6}$ & $10^{-5}$ \\
\bottomrule
\end{tabular}
\caption{Suggested tolerances (dimensionless; scale to data).}
\end{table}

\begin{figure}[ht]
\centering
\begin{tikzpicture}
\begin{axis}[
width=0.8\textwidth,height=0.35\textwidth,
xlabel={Iteration},ylabel={Log residual},
ymin=-10,ymax=1, grid=both, legend pos=south west]
\addplot coordinates {(0,0) (5,-0.8) (10,-1.6) (15,-2.5) (20,-3.4) (25,-4.2) (30,-5.0) (35,-5.6) (40,-6.2) (45,-6.7) (50,-7.1)};
\addlegendentry{$\|\mathcal{R}_{\mathrm{ME}}\|$}
\end{axis}
\end{tikzpicture}
\caption{Placeholder: typical convergence of the master-equation residual.}
\end{figure}

\paragraph{Sanity checks.}
\begin{itemize}[leftmargin=1.25em]
\item \emph{No-price-limit case.} If $P$ is flat, the price dependence on $m$ vanishes. Route A and B should collapse to the same frictional-control model without cross effects.
\item \emph{Symmetric costs.} Setting $\phi_-=\phi_+$ removes the kink; $i^*$ is linear in $V_k-1$ everywhere. FP becomes smoother; residuals drop faster.
\item \emph{Elasticity sweep.} Under isoelastic demand, $\eta$ scales the marginal-revenue wedge linearly; recovered investment schedules should contract monotonically in $\eta$.
\end{itemize}

%========================
% % Economics
% %========================
\section{Economics: Aggregation, Irreversibility, Comparative Statics}

\paragraph{Aggregation.}
Aggregation enters through $P\big(Y(m,x)\big)$ within the HJB. Under isoelastic demand, the effective marginal-revenue wedge is $-\eta P(Y)\,e^{x+z}k^\alpha$, which acts as a proportional reduction in marginal revenue.

\paragraph{Irreversibility.}
The asymmetry $\phi_->\phi_+$ creates a kink in the Hamiltonian and investment bands: for $V_k$ just below $1$ the disinvestment response is muted relative to the investment response for $V_k$ just above $1$. At the distributional level, this slows the left-tail motion in $k$, thickening the mass near low capital.

\paragraph{Comparative statics.}
\begin{itemize}[leftmargin=1.25em]
\item Larger $\eta$ (steeper demand) amplifies the negative externality, reducing investment and shifting mass in $m$ toward lower $k$.
\item Bigger $\phi_- - \phi_+$ widens irreversibility bands and slows capital reallocation, increasing dispersion in $k$ conditional on $z$.
\item Higher $\sigma_z$ spreads the cross-section in $z$, raising $Y$ volatility and, through $P'(Y)$, modulating the marginal-revenue wedge over the business cycle.
\item Higher $\sigma_x$ (through $\Lx$) deepens precautionary effects via $r(x)$ and the HJB drift terms, with ambiguous effects on average investment depending on curvature.
\item A countercyclical $r(x)$ strengthens the value premium mechanism Ã  la costly reversibility by raising discount rates in recessions precisely when $P'(Y)$ is most negative.
\end{itemize}

%========================
% Appendix A
%========================
\appendix
\section{Appendix A: Derivations and Technical Lemmas}\label{app:derivations}

\begin{tcolorbox}[mathstyle]
\textbf{Correction and Addenda.} The derivation of the Master Equation is corrected to exclude a separate $\int \delta\_m \pi\,\diff m$ term; see \Cref{thm:ME} and \S\ref{sec:me-externality}. Below we provide compact verification artifacts for the envelope identity and for the functional chain rule used in the population-transport term.
\end{tcolorbox}

\subsection*{Envelope identity (with depreciation term)}
Let $p=V_k$ and $\mathcal{H}(k,\cdot)=\max_i\{\pi + p(i-\delta k)\}$. Then $\partial_p\mathcal{H}=i^*(p)-\delta k$.

\begin{sympycheck}
import sympy as sp
i,k,p,phi_p,phi_m,delta = sp.symbols('i k p phi_p phi_m delta', positive=True)
h_p = sp.Rational(1,2)*phi_p*i**2/k
h_m = sp.Rational(1,2)*phi_m*i**2/k
sol_p = k*(p-1)/phi_p
sol_m = k*(p-1)/phi_m
H_p = (-i - h_p + p*(i - delta*k)).subs(i, sol_p)
H_m = (-i - h_m + p*(i - delta*k)).subs(i, sol_m)
assert sp.simplify(sp.diff(H_p,p) - (sol_p - delta*k)) == 0
assert sp.simplify(sp.diff(H_m,p) - (sol_m - delta*k)) == 0
\end{sympycheck}

\subsection*{Functional chain rule (structure check)}
For a one-dimensional diffusion with drift $\mu$ and variance $\sigma^2$, the chain rule applied to $\Dm F$ has the schematic form $\mu\,\partial\_\xi(\Dm F)+\tfrac12\sigma^2\,\partial^2\_{\xi\xi}(\Dm F)$.

\begin{sympycheck}
import sympy as sp
xi = sp.symbols('xi', real=True)
mu = sp.Function('mu')(xi)
sig2 = sp.symbols('sig2', positive=True)
g = sp.Function('g')(xi)
expr = mu*sp.diff(g, xi) + sp.Rational(1,2)*sig2*sp.diff(g, xi, 2)
assert expr.has(sp.Derivative(g, xi)) and expr.has(sp.Derivative(g,(xi,2)))
\end{sympycheck}

\begin{lemma}{Functional Chain Rule for FP Flows}{chain_rule_fp_app}
Let $m_t$ solve the FP equation $\partial_t m = \mathcal L^{\!*} m$ with drift $b(\xi)$ and diffusion matrix $\sigma(\xi)\sigma(\xi)^\top$. If $F:\mathcal P_2(S)\to\R$ is sufficiently regular (in the sense of Lions), then
\[
\frac{\mathrm d}{\mathrm dt} F(m_t)
= \int_S \Big( \langle \nabla_\xi (\Dm F)(m_t)(\xi),\, b(\xi) \rangle
  + \tfrac12 \, \mathrm{Tr}\big[\sigma\sigma^\top(\xi)\, \nabla^2_\xi (\Dm F)(m_t)(\xi)\big] \Big) \, m_t(\diff \xi).
\]
\emph{Proof sketch.} Apply the functional It\^o calculus on $\mathcal P_2$ to $F(m_t)$ and the adjoint pairing to identify the generator acting componentwise on $\Dm F$. See \cite[Ch.~5]{carmona_delarue_2018_mfg} and \cite{cardaliaguet_delarue_lasry_lions_2019}.
\end{lemma}

\subsection{Envelope/KKT and policy recovery}
From \eqref{eq:HJB}, define $p=V_k$. The Hamiltonian
$\mathcal{H}(k,z,x,m,p)=\max_i\{\pi+p(i-\delta k)\}$
is the convex conjugate of $h$ shifted by $p-1$. The envelope condition $V_k=\partial_p \mathcal{H}$ combined with the FOC for $i$ produces the piecewise-affine policy in \Cref{prop:policy}. The kink at $p=1$ corresponds to $i=0$. KKT adds the complementary slackness $\lambda\cdot(i+\kbar(k))=0$ when a lower bound is present.

\subsection{Adjoint pairing for FP}
Let $\varphi$ be a smooth test function. Then

$$
\frac{\diff}{\diff t}\int \varphi\,\diff m_t
= \int \varphi_k (i^*-\delta k)\,\diff m_t + \int \Lz \varphi\,\diff m_t
= \int \varphi\,\diff\Big(-\partial_k[(i^*-\delta k)m_t]+\Lzadj m_t\Big).
$$

Stationarity imposes \eqref{eq:FP} with $\partial_t m=0$. Reflecting at $k=0$ eliminates the boundary integral.
% Verification note: adjoint pairing identity is checked in Appendix E.

\subsection{Functional Calculus and the Master Equation}\label{app:master-derivation}
Consider a flow $t\mapsto (K_t,Z_t)$ for the tagged firm following control $i_t$ and a flow of measures $t\mapsto m_t$ solving \eqref{eq:FP} under the feedback $i^*(\cdot,m_t)$. By functional ItÃ´'s lemma for $U(K_t,Z_t,x,m_t)$,
\begin{align*}
\diff U &= U_k\,\diff K_t + U_z\,\diff Z_t + \tfrac12 U_{zz}\,\sigma_z^2\,\diff t \\
        &\quad + \big(\partial_t U\big|_{m}\big)\,\diff t, \\
\partial_t U\big|_{m} &= \int \Big[ (i^*(\xi,x,m)-\delta\kappa)\,\partial_{\kappa}\big(\Dm U\big)\!\_\kappa
  +\mu_z(\zeta)\,\partial_{\zeta}\big(\Dm U\big)\!\_\zeta
  +\tfrac12\sigma_z^2\,\partial_{\zeta\zeta}^2\big(\Dm U\big)\!\_\zeta\Big] \, m(\diff \xi).
\end{align*}
Taking expectations under the pricing measure with short rate $r(x)$ and imposing stationarity yields the stationary master equation (ME) in \Cref{thm:ME}: the own-firm HJB terms and the population-transport term. The dependence of $\pi$ on $m$ (via $P(Y(m,x))$) is already handled inside the Hamiltonian and does not appear as a separate explicit term.

\subsection{Externality term in detail}
Write $\pi(k,i,z,x,m)=\Psi(Y(m,x))\,\chi(k,z,x)-i-h(i,k)-f$ with $\Psi=P$ and $\chi=e^{x+z}k^\alpha$. Then

$$
\delta\_m\pi(m)(\xi)=\Psi'(Y)\,\chi(k,z,x)\,\chi(\kappa,\zeta,x),
$$

and integration w\.r.t.\ $m$ yields $\chi(k,z,x)\,\Psi'(Y)\,Y(m,x)$.

%========================
% Appendix B
%========================
\section{Appendix B: Residual-Loss Template (for implementation)}\label{app:loss}

For a collocation tuple $(k,z,x)$, an empirical measure $m=\tfrac1N\sum_{n=1}^N \delta_{\xi^n}$, and parameterized $U_\omega,\dmU_\psi$, define
\begin{align*}
\widehat{Y} &\equiv \frac{1}{N}\sum\_{n=1}^N e^{x+\zeta^n}(\kappa^n)^\alpha,\\
\widehat{\mathcal{R}}_{\mathrm{ME}} &\equiv r(x)\,U_\omega\\
  &\quad - \max_{i}\Big\{ \pi + (U_{\omega})_k\,(i-\delta k) + \Lz U_{\omega} + \Lx U_{\omega} \Big\} \\
  &\quad - \frac{1}{N}\sum_{n=1}^N \Big[ (i^*(\xi^n,x,m)-\delta\kappa^n)\,\partial_{\kappa}\dmU_{\psi}(\xi^n)
    + \mu_z(\zeta^n)\,\partial_{\zeta}\dmU_{\psi}(\xi^n)
    + \tfrac12 \sigma_z^2\,\partial^2_{\zeta\zeta}\dmU_{\psi}(\xi^n) \Big] \\
  &\quad \phantom{.}
  \end{align*}
  Add soft KKT penalties (one-sided around $(U_\omega)_k=1$), an anchoring penalty $\mathcal{P}_{\mathrm{anchor}}=\big(\int \dmU\,\diff m\big)^2$ to fix the gauge, and boundary regularizers (reflecting $k=0$, growth at $k_{\max}$). Minimize

$$
\mathcal{L}=\E\big[\widehat{\mathcal{R}}_{\mathrm{ME}}^2\big]+\lambda_{\mathrm{KKT}}\mathcal{P}_{\mathrm{KKT}}
+\lambda_{\mathrm{bdry}}\mathcal{P}_{\mathrm{bdry}}+\lambda_{\mathrm{anchor}}\mathcal{P}_{\mathrm{anchor}}.
$$

Anchoring removes the gauge freedom in $\dmU$.

%========================
% Appendix C
%========================
\section{Appendix C: Common-Noise Master Equation (Reference Note)}\label{app:common-noise}

When the population law $m_t$ itself diffuses under common noise (say through an exogenous $x_t$ or an aggregate Brownian component shared by firms), the functional ItÃ´ calculus on $\mathcal P_2$ introduces a second-order term in the measure variable. In a stylized form (see Carmona \& Delarue, and Cardaliaguet--Delarue--Lasry--Lions), the stationary master equation would add a term of the form

$$
\frac{1}{2}\,\Sigma_{\mathrm{com}}:\!\int\!\!\int
\partial_{\xi}\partial_{\xi'} \big(\Dm U(\xi)\big)\,\big(\Dm U(\xi')\big)
\, m(\diff \xi)\, m(\diff \xi')
$$

or, in classical PDE notation,
$\tfrac12 \mathrm{Tr}\big[\Gamma\,\partial_{\xi\xi}^2 \dmU\big]$
integrated against $m$, where $\Gamma$ is the covariance of the common noise. Because this paper conditions on $x$, these terms are absent in the stationary master equation.

%========================
% Appendix D
%========================
\section{Appendix D: Tiny Pseudocode (Plain \texorpdfstring{\texttt{listings}}{listings})}\label{app:code}

\lstset{
basicstyle=\ttfamily\small,
columns=fullflexible,
showstringspaces=false,
frame=single,
framerule=0.4pt,
breaklines=true,
tabsize=2,
captionpos=b
}

\begin{lstlisting}[language=Python,caption={Pseudo-JAX for (ME) residual with empirical measure}]

# Inputs:

# params\_omega: parameters for U(k,z,x; m)

# params\_psi:   parameters for delta\_m U(xi; k,z,x; m)

# batch:        list of tuples (k,z,x, {xi\_n=(kappa\_n,zeta\_n)}\_{n=1}^N )

# primitives:   alpha, delta, mu\_z(z), sigma\_z, mu\_x(x), sigma\_x, r(x),

# demand P(Y), fixed cost f

# penalties:    lambdas for KKT, boundary, and anchor (gauge) regularizers

def policy\_from\_grad(p, k, phi\_plus, phi\_minus):
\# p = U\_k (value gradient)
if p >= 1.0:
return (k/phi\_plus)*(p - 1.0)
else:
return (k/phi\_minus)*(p - 1.0)

def reflecting\_penalty(k, i\_star):
\# discourage negative control at k=0 and large negative flux
pen0 = max(0.0, -i\_star) if k<=1e-10 else 0.0
return pen0\*\*2

def h\_cost(i, k, phi\_plus, phi\_minus):
if i >= 0.0:
return 0.5*phi\_plus*(i*i)/max(k,1e-12)
else:
return 0.5*phi\_minus\*(i\*i)/max(k,1e-12)

def HJB\_operator(k,z,x,Yhat,Uk,Uz,Uzz,Ux,Uxx,i):
q  = exp(x+z)*(k\*\*alpha)
pi = P(Yhat)*q - i - h\_cost(i,k,phi\_plus,phi\_minus) - f
return pi + Uk*(i - delta*k) + mu\_z(z)*Uz + 0.5*sigma\_z**2\*Uzz&#x20;
\+ mu\_x(x)*Ux + 0.5*sigma\_x**2\*Uxx

def ME\_residual\_for\_tuple(params\_omega, params\_psi, tup):
k,z,x,xi\_list = tup.k, tup.z, tup.x, tup.xi\_list
\# empirical measure moments
Y\_hat = mean(\[exp(x+xi.zeta)*(xi.kappa\*\*alpha) for xi in xi\_list])
\# U and its partials at (k,z,x)
U, Uk, Uz, Uzz, Ux, Uxx = U\_and\_grads(params\_omega, k,z,x, xi\_list)
\# best response i*
i\_star = policy\_from\_grad(Uk, k, phi\_plus, phi\_minus)
\# HJB maximand at i\*
H\_val  = HJB\_operator(k,z,x,Y\_hat,Uk,Uz,Uzz,Ux,Uxx,i\_star)
\# Population transport term (via the Lions derivative)
integ = 0.0
for xi in xi\_list:
dU = delta\_mU\_and\_partials(params\_psi, xi, k,z,x, xi\_list)
\# dU returns dict with fields dkappa, dzeta, dzeta2, p\_k (proxy gradient)
i\_star\_xi = policy\_from\_grad(dU\['p\_k'], xi.kappa, phi\_plus, phi\_minus)
integ += (i\_star\_xi - delta*xi.kappa)* dU\['dkappa']&#x20;
\+ mu\_z(xi.zeta)\* dU\['dzeta']&#x20;
\+ 0.5*sigma\_z\*\*2 \* dU\['dzeta2']
integ = integ / len(xi\_list)
\# assemble residual (no separate externality term; price enters via P(Yhat) in HJB)
res  = r(x)\*U - max(H\_val, HJB\_operator(k,z,x,Y\_hat,Uk,Uz,Uzz,Ux,Uxx,0.0))&#x20;\- integ
\# penalties
pen  = reflecting\_penalty(k, i\_star)
return res, pen

def loss(params\_omega, params\_psi, batch):
sse = 0.0
pen = 0.0
for tup in batch:
res, p = ME\_residual\_for\_tuple(params\_omega, params\_psi, tup)
sse += res\*\*2
pen += p
anchor = anchor\_penalty(params\_psi, batch)  # e.g., squared mean of dmU over batch
return sse/len(batch) + lambda\_bdry\*pen + lambda\_anchor\*anchor
\end{lstlisting}

%========================
% Appendix E
%========================
\section{Appendix E: Symbolic Verification (PythonTeX + SymPy)}\label{app:verification}

\noindent This appendix runs minimal SymPy checks to verify key derivations used in the text. Compilation is configured (via \texttt{latexmkrc}) to execute these checks on every build; any failure triggers a build error. We assume smoothness and reflecting/no-flux boundary conditions where noted.

\begin{pyconsole}
import sympy as sp

# 1) Isoelastic simplification:  Y P'(Y) = -eta P(Y)
Y, eta = sp.symbols('Y eta', positive=True)
P = Y**(-eta)
check1 = sp.simplify(Y*sp.diff(P, Y) + eta*P)
assert check1 == 0
print("Isoelastic: Y*P'(Y) = -eta*P(Y)  [OK]")

# 2) Externality directional derivative:  d/d epsilon P(Y+epsilon*chi_eps)*chi0 |_{epsilon=0}
#     equals P'(Y) * chi0 * chi_eps
chi0, chieps, eps = sp.symbols('chi0 chieps eps', real=True)
Psi = lambda y: y**(-eta)
dpi = sp.diff(Psi(Y + eps*chieps)*chi0, eps).subs(eps, 0)
target = sp.diff(Psi(Y), Y) * chi0 * chieps
assert sp.simplify(dpi - target) == 0
print('Externality directional derivative  [OK]')

# 3) Externality, isoelastic reduction after integrating over m:  chi0 * Y * P'(Y) = -eta * P(Y) * chi0
lhs = chi0 * Y * sp.diff(Psi(Y), Y)
rhs = -eta * Psi(Y) * chi0
assert sp.simplify(lhs - rhs) == 0
print('Externality isoelastic reduction   [OK]')

# 4) KKT/FOC solution for i* with asymmetric quadratic costs
#    h = 0.5*phi_plus*i^2/k for i>=0;   0.5*phi_minus*i^2/k for i<0
i, k, p, phi_plus, phi_minus = sp.symbols('i k p phi_plus phi_minus', positive=True)
h_plus  = 0.5*phi_plus*i**2/k
FOC_plus  = sp.Eq(sp.diff(-i - h_plus + p*i, i), 0)
sol_plus  = sp.solve(FOC_plus, i)[0]
h_minus = 0.5*phi_minus*i**2/k
FOC_minus = sp.Eq(sp.diff(-i - h_minus + p*i, i), 0)
sol_minus = sp.solve(FOC_minus, i)[0]
assert sp.simplify(sol_plus  - k*(p-1)/phi_plus)  == 0
assert sp.simplify(sol_minus - k*(p-1)/phi_minus) == 0
print('KKT/FOC piecewise i* formulas     [OK]')

# 5) FP adjoint pairing identity (algebraic, boundary terms omitted):
#    phi_k * (a*m) = d_k(phi*a*m) - phi * d_k(a*m)
kk = sp.symbols('kk', real=True)
phi = sp.Function('phi')(kk)
a   = sp.Function('a')(kk)
mm  = sp.Function('m')(kk)
expr = sp.diff(phi, kk)*(a*mm) - (sp.diff(phi*(a*mm), kk) - phi*sp.diff(a*mm, kk))
assert sp.simplify(expr) == 0
print('Adjoint pairing identity (no-flux) [OK]')

# 6) Envelope property for Hamiltonian in p: d/dp max_i { -i - h(i,k) + p i } = i*(p)
#    Check separately on each branch (ignoring terms not depending on i, e.g., -delta*k*p)
H_plus  = (-i - h_plus + p*i).subs(i, sol_plus)
H_minus = (-i - h_minus + p*i).subs(i, sol_minus)
dHp_dp  = sp.simplify(sp.diff(H_plus, p))
dHm_dp  = sp.simplify(sp.diff(H_minus, p))
assert sp.simplify(dHp_dp - sol_plus) == 0
assert sp.simplify(dHm_dp - sol_minus) == 0
print('Envelope: dH/dp equals i*(p)       [OK]')

print('\nAll SymPy verification checks passed.')
\end{pyconsole}

%========================
% Appendix F
%========================
\section{Appendix F: Lean4 Micro-Proofs (Sketches)}\label{app:lean}

\noindent The following Lean4/mathlib4 snippets formalize two identities used in the text. They are provided as self-contained, runnable sketches (assuming a recent mathlib4): the isoelastic simplification $Y\,P'(Y)=-\eta P(Y)$ and the algebraic reduction $Y\cdot Y^{-\eta-1}=Y^{-\eta}$ for $Y>0$.

\lstset{basicstyle=\ttfamily\small,columns=fullflexible,showstringspaces=false,frame=single,framerule=0.4pt,breaklines=true,tabsize=2,captionpos=b}
\begin{lstlisting}[language=Lean,caption={Lean4: isoelastic identity and algebraic reduction}]
import Mathlib.Analysis.Calculus.Deriv
import Mathlib.Data.Real.Basic

open Real

variable {Î· Y : â„}

-- P(Y) = Y ^ (-Î·), defined for Y > 0 via rpow
def P (Y : â„) (Î· : â„) : â„ := Y ^ (-Î·)

-- Algebraic reduction: for Y > 0, Y * Y^(-Î· - 1) = Y^(-Î·)
theorem rpow_mul_cancel (hY : 0 < Y) :
    Y * Y ^ (-Î· - 1) = Y ^ (-Î·) := by
  -- rewrite Y as Y^1 and use rpow_add (valid for Y > 0)
  have h1 : Y = Y ^ (1 : â„) := by simpa using (rpow_one Y)
  calc
    Y * Y ^ (-Î· - 1)
        = Y ^ (1 : â„) * Y ^ (-Î· - 1) := by simpa [h1]
    _   = Y ^ ((1 : â„) + (-Î· - 1)) := by
            simpa using (rpow_mul_rpow_of_pos hY (1 : â„) (-Î· - 1))
    _   = Y ^ (-Î·) := by ring

-- Differential identity: for Y > 0,  (Y) * (deriv (fun y => P y Î·) Y) = -Î· * P Y Î·
theorem isoelastic_identity (hY : 0 < Y) :
    Y * (deriv (fun y => P y Î·) Y) = -Î· * P Y Î· := by
  -- mathlib: d/dy (y^a) = a * y^(a-1) for y>0
  have hderiv : deriv (fun y => y ^ (-Î·)) Y = (-Î·) * Y ^ (-Î· - 1) := by
    simpa using (deriv_rpow_const (x:=Y) (a:=-Î·) hY.ne')
  -- multiply both sides by Y and reduce
  calc
    Y * (deriv (fun y => P y Î·) Y)
        = Y * ((-Î·) * Y ^ (-Î· - 1)) := by simpa [P, hderiv]
    _   = -Î· * (Y * Y ^ (-Î· - 1)) := by ring
    _   = -Î· * Y ^ (-Î·) := by simpa using rpow_mul_cancel (Î·:=Î·) (Y:=Y) hY
    _   = -Î· * P Y Î· := by rfl
\end{lstlisting}

\begin{tcolorbox}[didacticstyle]
\textbf{Notes.} The lemmas use $\mathrm{rpow}$ and standard calculus from \texttt{mathlib4}. They require $Y>0$ for real-exponent laws. The SymPy checks in \Cref{app:verification} independently validate the same identities numerically/symbolically.
\end{tcolorbox}

% Additional Lean sanity checks for EZ risk-coefficient (Appendix G)
\lstset{basicstyle=\ttfamily\small,columns=fullflexible,showstringspaces=false,frame=single,framerule=0.4pt,breaklines=true,tabsize=2,captionpos=b}
\begin{lstlisting}[language=Lean,caption={Lean4: EZ risk-coefficient sanity checks}]
import Mathlib.Data.Real.Basic

-- Risk coefficient appearing in the EZ market price of risk
def risk_coeff (Î³ Ïˆ : â„) : â„ := (1 - Î³) * (1 - 1/Ïˆ)

-- If RRA = 1 (log utility), the utility-channel risk coefficient vanishes
@[simp] lemma risk_coeff_gamma_one (Ïˆ : â„) : risk_coeff 1 Ïˆ = 0 := by
  simp [risk_coeff]

-- If EIS = 1, the utility-channel risk coefficient vanishes
@[simp] lemma risk_coeff_psi_one (Î³ : â„) : risk_coeff Î³ 1 = 0 := by
  simp [risk_coeff]
\end{lstlisting}

%========================
% Bibliography (manual)
%========================
%========================
% Endogenous SDF: Epstein--Zin
%========================
\section{Appendix G: Endogenous SDF with Epstein--Zin Aggregator}\label{sec:ez}

When the stochastic discount factor (SDF) is endogenous, it is often derived from a representative agent's preferences. Epstein--Zin (EZ) preferences allow separating the elasticity of intertemporal substitution (EIS) from relative risk aversion (RRA), which is crucial for asset pricing implications. This appendix details the continuous-time EZ aggregator used as a BSDE driver and derives the corresponding pricing kernel exposure.

\begin{definition}{Continuous-time Epstein--Zin Aggregator}{ez}
Fix time preference $\varrho>0$ (using notation from \Cref{sec:notation}), risk aversion $\gamma>0$, and elasticity of intertemporal substitution $\psi>0$. We assume $\psi\neq 1$. Let
\[
\vartheta \equiv \frac{1-\gamma}{1-1/\psi}.
\]
The parameter $\vartheta$ is sometimes used in alternative normalizations of the utility index.

For aggregate consumption $c_t>0$, the representative agent's utility process $(V_t, Z_t)$ solves the backward SDE:
\[
\diff V_t = -f(c_t, V_t, Z_t)\diff t + Z_t^\top \diff B_t,
\]
where $V_t>0$ is the continuation value and $Z_t\in\mathbb{R}^{d_B}$ is the exposure vector to aggregate Brownian shocks $B_t$. The driver $f$ is the EZ aggregator. We use the standard normalization (consistent with Duffie--Epstein, 1992, \cite{duffie_epstein_1992}, and also used in \cite{Sauzet2023}):
\begin{equation}\label{eq:ez-agg}
f(c,V,Z)
= \frac{\varrho}{1-1/\psi}\Big( c^{\,1-1/\psi}\,V^{\,1/\psi} - V \Big)
\; +\; \tfrac{1}{2}\,(1-\gamma)\,(1-1/\psi)\,\frac{\norm{Z}^2}{V}.
\end{equation}
\end{definition}

\begin{tcolorbox}[didacticstyle]
\textbf{Economic Intuition: Separating RRA and EIS.}
EZ preferences break the link imposed by standard CRRA utility (where EIS $= 1/\text{RRA}$).
\begin{itemize}[leftmargin=1.15em,itemsep=0.25em]
 \item $\gamma$ (RRA) controls aversion to static risk (gambles).
 \item $\psi$ (EIS) controls willingness to substitute consumption over time (smoothness).
\end{itemize}
The aggregator $f$ includes an intertemporal substitution term (first part) and a risk adjustment term (second part). The sign of the risk adjustment coefficient $(1-\gamma)(1-1/\psi)$ determines the preference for early ($\gamma>1, \psi>1$ or $\gamma<1, \psi<1$) or late resolution of uncertainty.
\end{tcolorbox}

\begin{proposition}{Pricing kernel exposure under EZ}{sdf-ez}
Let $M_t$ denote the stochastic discount factor. The utility-channel diffusion
component of the instantaneous market price of risk implied by
\Cref{def:ez} is
\[
\Lambda^{\mathrm{util}}_t \;=\; \partial_Z f(c_t, V_t, Z_t) \;=\; (1-\gamma)\,(1-1/\psi)\,\frac{Z_t}{V_t},
\]
entering $\mathrm{d}M_t/M_t = -r_t\,\mathrm{d}t - (\Lambda_t)^{\!\top}\,\mathrm{d}B_t$.
If consumption $c_t$ carries its own Brownian exposure, the total $\Lambda_t$ adds
the consumption channel in the usual way.
\end{proposition}

\begin{proof}
The pricing kernel $M_t$ ensures that the utility process $V_t$, when discounted by $M_t$, is a martingale: $\E_t[M_{t+s} V_{t+s}] = M_t V_t$.
Applying It\^o's lemma to the product $M_t V_t$ gives
\[
\diff (M_t V_t) = V_t \,\diff M_t + M_t \,\diff V_t + \langle \diff M_t, \diff V_t \rangle.
\]
Substitute the dynamics
\begin{align*}
\diff M_t/M_t &= -r_t\,\diff t - \Lambda_t^\top \,\diff B_t, \\
\diff V_t &= -f(c_t, V_t, Z_t)\diff t + Z_t^\top \,\diff B_t,
\end{align*}
and note the quadratic covariation $\langle \diff M_t, \diff V_t \rangle = -M_t\, \Lambda_t^\top Z_t\,\diff t$.
For $M_t V_t$ to be a martingale, the drift must vanish:
\[
V_t (-M_t r_t) + M_t (-f(c_t, V_t, Z_t)) - M_t \,\Lambda_t^\top Z_t = 0,
\]
yielding the generalized HJB identity $r_t V_t + f(c_t,V_t,Z_t) + \Lambda_t^\top Z_t = 0$.
In equilibrium, the utility-channel component of the market price of risk is identified with the gradient of the aggregator with respect to $Z_t$ (see \cite{duffie_epstein_1992}). Differentiating \Cref{eq:ez-agg} w.r.t. $Z$ gives
\[
\partial_Z f(c,V,Z) \,=\, \tfrac{1}{2}(1-\gamma)(1-1/\psi)\,\partial_Z\!\left(\frac{\norm{Z}^2}{V}\right)
\,=\, (1-\gamma)(1-1/\psi)\,\frac{Z}{V},
\]
which proves the claim.
\end{proof}

\begin{sympycheck}
import sympy as sp
# Verify the gradient calculation in the proof of Proposition G.1
# using an element-wise approach for robustness.
c, V, gamma, psi = sp.symbols('c V gamma psi', positive=True)
z1, z2 = sp.symbols('z1 z2', real=True)
Z = sp.Matrix([z1, z2])

# Coefficient in the standard normalization (Duffie--Epstein)
coeff_risk = (1-gamma)*(1-1/psi)

# Risk term: (1/2) * coeff * (Z^T Z) / V
risk_term = sp.Rational(1, 2) * coeff_risk * (Z.T * Z)[0, 0] / V

# Gradient with respect to Z's components
grad_Z = sp.Matrix(sp.derive_by_array(risk_term, [z1, z2]))
expected = coeff_risk * Z / V

# Robust check: ensure both components are exactly zero
difference = sp.simplify(grad_Z - expected)
assert all(e == 0 for e in difference)
\end{sympycheck}

\begin{tcolorbox}[mathstyle]
\textbf{Integration with the Firm Problem.}
When using an endogenous SDF, the firm's HJB equation (\Cref{eq:HJB-EZ}) incorporates the market price of risk $\Lambda_t$:
\[
r_t\,V \,=\, \max_{i} \Big\{ \pi + V_k\,(i-\delta k) + \Lz V + \Lx V - (\sigma_z V_z,\, \sigma_x V_x)\cdot\Lambda_t \Big\}.
\]
If the aggregate shocks $x$ correspond to the Brownian motion $B_t$ driving EZ utility, this links firm valuation to representative-agent preferences via $\Lambda_t$.
\end{tcolorbox}

\begin{tcolorbox}[didacticstyle]
\textbf{Implementation hook.} The repository exposes a JAX-friendly generator
for \Cref{eq:ez-agg} and a utility-channel SDF exposure helper:
\begin{verbatim}
bsde_dsgE/models/epstein_zin.py: EZParams, ez_generator, sdf_exposure_from_ez
bsde_dsgE/models/multicountry.py: preference="EZ" to enable the aggregator
\end{verbatim}
Usage sketch in code:
\begin{verbatim}
from bsde_dsgE.models.epstein_zin import EZParams
from bsde_dsgE.models.multicountry import multicountry_model

params = EZParams(rho=0.02, gamma=10.0, psi=1.5)  # Use rho for time preference
problem = multicountry_model(dim=5, preference="EZ", ez_params=params)
\end{verbatim}
The consumption mapping \verb|c_fn(x)| can be provided by the user; by default,
the model uses a positive aggregator from dividend-like states.
\end{tcolorbox}

%========================
% Bibliography (manual)
%========================
\begin{thebibliography}{99}\small

\bibitem{carmona_delarue_2018_mfg} Carmona, R. and F. Delarue (2018).
\emph{Probabilistic Theory of Mean Field Games with Applications.}
Springer.

\bibitem{cardaliaguet_delarue_lasry_lions_2019} Cardaliaguet, P., F. Delarue, J.-M. Lasry, and P.-L. Lions (2019).
\emph{The Master Equation and the Convergence Problem in Mean Field Games.}
Princeton University Press.

\bibitem{lasry_lions_2007} Lasry, J.-M. and P.-L. Lions (2007).
Mean field games.
\emph{Japanese Journal of Mathematics} 2(1): 229--260.

\bibitem{zaheer2017deepsets} Zaheer, M., S. Kottur, S. Ravanbakhsh, B. Poczos, R. Salakhutdinov, and A. Smola (2017).
Deep Sets.
\emph{Advances in Neural Information Processing Systems (NeurIPS)} 30.

\bibitem{mou_zhang_cn_master} Mou, C.-H. and J. Zhang (various years).
Second-order master equations with common noise and displacement monotonicity.
(Working papers / journal articles; see also related notes by Gangbo--MÃ©szÃ¡ros--Mou--Zhang.)

\bibitem{zhang_2005_value_premium} Zhang, L. (2005).
The value premium.
\emph{Journal of Finance} 60(1): 67--103.

\bibitem{duffie_epstein_1992} Duffie, D. and L. G. Epstein (1992).
Stochastic Differential Utility.
\emph{Econometrica} 60(2): 353--394.

\bibitem{Sauzet2023} Sauzet, M. (2023).
Recursive preferences in continuous time and implications for asset pricing.
(Working paper; aggregator normalisation consistent with \Cref{def:ez}.)

\end{thebibliography}

\end{document}
